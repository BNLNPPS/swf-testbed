<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 900" font-family="Arial, sans-serif" font-size="14">
  <!-- Background -->
  <rect width="700" height="900" fill="white"/>

  <!-- Styles -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arrowhead-dashed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32"/>
    </marker>
  </defs>

  <!-- MAIN PIPELINE (centered at x=250) -->

  <!-- DAQ Simulator -->
  <rect x="150" y="20" width="200" height="40" rx="5" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
  <text x="250" y="45" text-anchor="middle" font-weight="bold">DAQ Simulator</text>

  <!-- Arrow + label -->
  <line x1="250" y1="60" x2="250" y2="90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="270" y="80" font-size="11" fill="#666">stf_gen</text>

  <!-- STF -->
  <rect x="175" y="95" width="150" height="35" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="250" y="118" text-anchor="middle" font-weight="bold">STF</text>

  <!-- Arrow -->
  <line x1="250" y1="130" x2="250" y2="160" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Data Agent -->
  <rect x="150" y="165" width="200" height="40" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="250" y="190" text-anchor="middle" font-weight="bold">Data Agent</text>

  <!-- Arrow + label -->
  <line x1="250" y1="205" x2="250" y2="235" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="270" y="225" font-size="11" fill="#666">stf_ready</text>

  <!-- FastMon Agent -->
  <rect x="150" y="240" width="200" height="40" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="250" y="265" text-anchor="middle" font-weight="bold">FastMon Agent</text>

  <!-- Arrow to STF Sample -->
  <line x1="250" y1="280" x2="250" y2="310" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Dashed arrow to other samples (moved to right) -->
  <line x1="350" y1="260" x2="420" y2="300" stroke="#999" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-dashed)"/>
  <text x="430" y="320" font-size="11" fill="#666">other samples</text>
  <text x="430" y="335" font-size="11" fill="#666">(other clients)</text>

  <!-- STF Sample -->
  <rect x="175" y="315" width="150" height="35" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="250" y="338" text-anchor="middle" font-weight="bold">STF Sample</text>

  <!-- Arrow + label -->
  <line x1="250" y1="350" x2="250" y2="380" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="270" y="370" font-size="11" fill="#666">tf_file_registered</text>

  <!-- Fast Processing Agent -->
  <rect x="150" y="385" width="200" height="40" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="250" y="410" text-anchor="middle" font-weight="bold">Fast Processing Agent</text>

  <!-- Arrow to slices -->
  <line x1="250" y1="425" x2="250" y2="455" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- TF Slices box -->
  <rect x="100" y="460" width="300" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="250" y="485" text-anchor="middle" font-weight="bold">TF Slices</text>
  <!-- Individual slices -->
  <rect x="120" y="505" width="55" height="25" rx="3" fill="#fff" stroke="#f57c00"/>
  <text x="147" y="522" text-anchor="middle" font-size="11">slice 1</text>
  <rect x="185" y="505" width="55" height="25" rx="3" fill="#fff" stroke="#f57c00"/>
  <text x="212" y="522" text-anchor="middle" font-size="11">slice 2</text>
  <rect x="250" y="505" width="55" height="25" rx="3" fill="#fff" stroke="#f57c00"/>
  <text x="277" y="522" text-anchor="middle" font-size="11">slice 3</text>
  <rect x="315" y="505" width="55" height="25" rx="3" fill="#fff" stroke="#f57c00"/>
  <text x="342" y="522" text-anchor="middle" font-size="11">...</text>

  <!-- Arrows from slices to workers -->
  <line x1="147" y1="540" x2="147" y2="580" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="212" y1="540" x2="212" y2="580" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="277" y1="540" x2="277" y2="580" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="342" y1="540" x2="342" y2="580" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- PanDA Workers box -->
  <rect x="100" y="585" width="300" height="80" rx="5" fill="#ede7f6" stroke="#512da8" stroke-width="2"/>
  <text x="250" y="605" text-anchor="middle" font-weight="bold">PanDA Workers</text>
  <!-- Individual workers -->
  <rect x="115" y="615" width="60" height="40" rx="3" fill="#fff" stroke="#512da8"/>
  <text x="145" y="632" text-anchor="middle" font-size="10">Worker 1</text>
  <text x="145" y="646" text-anchor="middle" font-size="9" fill="#666">EICrecon</text>
  <rect x="185" y="615" width="60" height="40" rx="3" fill="#fff" stroke="#512da8"/>
  <text x="215" y="632" text-anchor="middle" font-size="10">Worker 2</text>
  <text x="215" y="646" text-anchor="middle" font-size="9" fill="#666">EICrecon</text>
  <rect x="255" y="615" width="60" height="40" rx="3" fill="#fff" stroke="#512da8"/>
  <text x="285" y="632" text-anchor="middle" font-size="10">Worker 3</text>
  <text x="285" y="646" text-anchor="middle" font-size="9" fill="#666">EICrecon</text>
  <rect x="325" y="615" width="60" height="40" rx="3" fill="#fff" stroke="#512da8"/>
  <text x="355" y="638" text-anchor="middle" font-size="14">...</text>

  <!-- Parallel arrows from workers to Reco Output -->
  <line x1="145" y1="655" x2="145" y2="695" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="215" y1="655" x2="215" y2="695" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="285" y1="655" x2="285" y2="695" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="355" y1="655" x2="355" y2="695" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Reconstruction Output -->
  <rect x="100" y="700" width="300" height="40" rx="5" fill="#e0e0e0" stroke="#616161" stroke-width="2"/>
  <text x="250" y="725" text-anchor="middle" font-weight="bold">Reconstruction Output</text>

  <!-- Convergence arrow to Analytics -->
  <line x1="250" y1="740" x2="250" y2="780" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Analytics -->
  <rect x="150" y="785" width="200" height="40" rx="5" fill="#fff9c4" stroke="#f9a825" stroke-width="2"/>
  <text x="250" y="810" text-anchor="middle" font-weight="bold">Analytics</text>

  <!-- TESTBED DB (on the right) -->
  <ellipse cx="550" cy="200" rx="80" ry="50" fill="#e1f5fe" stroke="#0288d1" stroke-width="2"/>
  <text x="550" y="195" text-anchor="middle" font-weight="bold">Testbed</text>
  <text x="550" y="215" text-anchor="middle" font-weight="bold">DB</text>

  <!-- Dashed line from Data Agent to DB -->
  <path d="M 350 185 Q 450 185 470 185" stroke="#666" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowhead-dashed)"/>
  <text x="400" y="175" font-size="11" fill="#666">STF record</text>

  <!-- Dashed line from FastMon Agent to DB -->
  <path d="M 350 260 Q 450 260 480 230" stroke="#666" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowhead-dashed)"/>
  <text x="400" y="250" font-size="11" fill="#666">sample records</text>

  <!-- Dashed line from Fast Processing Agent to DB -->
  <path d="M 350 405 Q 550 405 550 250" stroke="#666" stroke-width="1.5" stroke-dasharray="5,3" fill="none" marker-end="url(#arrowhead-dashed)"/>
  <text x="480" y="380" font-size="11" fill="#666">slice bookkeeping</text>

  <!-- === RIGHT SIDE: Smooth arc Fast Proc -> iDDS -> PanDA -> Workers === -->
  <!-- iDDS and PanDA stacked vertically at same x (rightmost point of arc) -->

  <!-- iDDS box at x=510, y=460 -->
  <rect x="510" y="460" width="100" height="45" rx="5" fill="#c8e6c9" stroke="#2e7d32" stroke-width="2"/>
  <text x="560" y="483" text-anchor="middle" font-weight="bold" font-size="12">iDDS</text>
  <text x="560" y="497" text-anchor="middle" font-size="9" fill="#666">Workflow Mgmt</text>

  <!-- PanDA box at x=510, y=530 (same x, stacked below) -->
  <rect x="510" y="530" width="100" height="45" rx="5" fill="#c8e6c9" stroke="#2e7d32" stroke-width="2"/>
  <text x="560" y="553" text-anchor="middle" font-weight="bold" font-size="12">PanDA</text>
  <text x="560" y="567" text-anchor="middle" font-size="9" fill="#666">Workload Mgmt</text>

  <!-- Smooth arc segments -->

  <!-- Fast Proc (350,405) -> iDDS top center (560,460) -->
  <path d="M 350 405 Q 560 405 560 460" stroke="#2e7d32" stroke-width="1.5" fill="none" marker-end="url(#arrowhead-green)"/>
  <text x="460" y="425" font-size="9" fill="#2e7d32">/topic/panda.workers</text>
  <text x="460" y="438" font-size="8" fill="#2e7d32">run_imminent + target_worker_count</text>

  <!-- iDDS bottom (560,505) -> PanDA top (560,530) -->
  <line x1="560" y1="505" x2="560" y2="530" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrowhead-green)"/>

  <!-- PanDA bottom (560,575) -> Workers right (400,625) -->
  <path d="M 560 575 Q 560 625 400 625" stroke="#2e7d32" stroke-width="1.5" fill="none" marker-end="url(#arrowhead-green)"/>

</svg>
